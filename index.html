<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>Ø³ÙˆØ¨Ø± Ø¨ÙƒØ± Ù…Ø§Ø±ÙŠÙˆ â€” Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠØ© ğŸ¶</title>
  <style>
    :root {
      --primary: #00f2fe;
      --secondary: #4facfe;
      --accent: #ff0055;
      --bg: #0a0b10;
      --card-bg: rgba(255, 255, 255, 0.05);
      --glass: rgba(20, 20, 25, 0.8);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0; padding: 0;
      background: var(--bg);
      color: #fff;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      height: 100vh;
      overflow: hidden;
      display: flex; flex-direction: column;
    }

    /* Ø®Ù„ÙÙŠØ© Ù…ØªØ­Ø±ÙƒØ© Ø¨Ø³ÙŠØ·Ø© */
    body::before {
      content: ""; position: absolute; inset: 0;
      background: radial-gradient(circle at 50% 50%, #1e2a44 0%, #0a0b10 100%);
      z-index: -1;
    }

    /* HUD - ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø±Ø¶ */
    .hud {
      display: grid; grid-template-columns: repeat(3, 1fr);
      padding: 15px; background: var(--glass);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      z-index: 5;
    }

    .stat-item { text-align: center; }
    .stat-label { font-size: 10px; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }
    .stat-value { font-size: 20px; font-weight: 800; color: var(--primary); display: block; }
    .mega-text { color: #ffcc00; text-shadow: 0 0 10px #ffcc00; }

    /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© */
    .game-container {
      flex: 1; position: relative;
      display: flex; align-items: center; justify-content: center;
      overflow: hidden;
    }

    canvas {
      max-width: 100%; max-height: 100%;
      box-shadow: 0 0 50px rgba(0,0,0,0.5);
      image-rendering: pixelated; /* Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø­Ø¯Ø© Ø§Ù„Ø±Ø³Ù… */
    }

    /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„ØªØ­ÙƒÙ… */
    .controls-area {
      padding: 20px; background: var(--glass);
      display: flex; justify-content: space-around; align-items: center;
      backdrop-filter: blur(10px);
    }

    .d-pad {
      display: grid; grid-template-columns: repeat(3, 65px); grid-template-rows: repeat(2, 60px); gap: 10px;
    }

    .btn-ctrl {
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
      border-radius: 15px; color: white; font-size: 24px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: 0.1s;
    }
    .btn-ctrl:active { background: var(--primary); transform: scale(0.9); }
    #btnUp { grid-column: 2; }
    #btnLeft { grid-column: 1; grid-row: 2; }
    #btnDown { grid-column: 2; grid-row: 2; }
    #btnRight { grid-column: 3; grid-row: 2; }

    /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© */
    .overlay {
      position: absolute; inset: 0; background: rgba(0,0,0,0.9);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 100; text-align: center; padding: 20px;
    }

    .card {
      background: var(--card-bg); padding: 30px; border-radius: 30px;
      border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(20px);
      max-width: 400px; width: 100%;
    }

    .btn-main {
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      border: none; padding: 15px 40px; border-radius: 50px;
      color: #000; font-weight: bold; font-size: 18px; cursor: pointer;
      margin-top: 20px; width: 100%; transition: 0.3s;
    }
    .btn-main:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(79, 172, 254, 0.4); }

    .toast {
      position: absolute; top: 100px; left: 50%; transform: translateX(-50%);
      background: var(--accent); padding: 10px 20px; border-radius: 20px;
      font-weight: bold; opacity: 0; pointer-events: none; transition: 0.3s;
    }
    .toast.show { opacity: 1; top: 80px; }

  </style>
</head>
<body>

<div class="hud">
  <div class="stat-item">
    <span class="stat-label">Ø§Ù„Ù†Ù‚Ø§Ø·</span>
    <span id="score" class="stat-value">000</span>
  </div>
  <div class="stat-item">
    <span class="stat-label">Ø§Ù„Ø£Ø­Ø°ÙŠØ© ğŸ‘Ÿ</span>
    <span id="eaten" class="stat-value">0</span>
  </div>
  <div class="stat-item">
    <span class="stat-label">Ø§Ù„Ù‡Ø¯Ù</span>
    <span id="target" class="stat-value">50</span>
  </div>
</div>

<div class="game-container" id="container">
  <canvas id="game"></canvas>
  <div id="toast" class="toast">ğŸ”¥ Ø®ÙˆØ´ ØªÙˆÙƒÙ„ Ø¨ÙƒØ± Ù‚Ù†Ø§Ø¯Ø±!</div>

  <div id="overlay" class="overlay">
    <div class="card">
      <h1 id="title">Ø¨ÙƒØ± Ù…Ø§Ø±ÙŠÙˆ Evolved</h1>
      <p style="color: #ccc; font-size: 14px; line-height: 1.6;">
        ÙˆÙƒÙ„ Ø¨ÙƒØ± Ø§Ù„Ø£Ø­Ø°ÙŠØ© Ù„ØªÙƒØ¨Ø±. Ø§Ø¨Ø­Ø« Ø¹Ù† <span class="mega-text">Ø§Ù„Ø®Ø±ÙŠØ© Ø§Ù„Ø°Ù‡Ø¨ÙŠ</span> Ø§Ù„Ù†Ø§Ø¯Ø± (+20)!<br>
        ØªØ¬Ù†Ø¨ Ø§Ù„Ø§ØµØ·Ø¯Ø§Ù… Ø¨Ù†ÙØ³Ùƒ.
      </p>
      <button id="startBtn" class="btn-main">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø¢Ù†</button>
      <button onclick="toggleFullScreen()" style="background:none; border:none; color:var(--primary); margin-top:15px; cursor:pointer;">Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© â›¶</button>
    </div>
  </div>
</div>

<div class="controls-area">
  <div class="d-pad">
    <div id="btnUp" class="btn-ctrl">â–²</div>
    <div id="btnLeft" class="btn-ctrl">â—€</div>
    <div id="btnDown" class="btn-ctrl">â–¼</div>
    <div id="btnRight" class="btn-ctrl">â–¶</div>
  </div>
  <div class="actions">
    <button id="pauseBtn" class="btn-ctrl" style="width: 60px; height: 60px; border-radius: 50%;">II</button>
  </div>
</div>

<script>
  /********* Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙÙ†ÙŠØ© *********/
  const GRID_COUNT = 20;
  let state = {
    snake: [], dir: {x:1, y:0}, nextDir: {x:1, y:0},
    food: null, bonus: null, megaBonus: null,
    score: 0, eaten: 0, speed: 120,
    running: false, paused: false, tick: 0
  };

  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");
  let tileSize = 0;

  function setupCanvas() {
    const container = document.getElementById("container");
    const size = Math.min(container.clientWidth, container.clientHeight) - 20;
    
    // ØªØµØ­ÙŠØ­ Ø§Ù„Ø¯Ù‚Ø© High DPI
    const dpr = window.devicePixelRatio || 1;
    canvas.width = size * dpr;
    canvas.height = size * dpr;
    canvas.style.width = size + "px";
    canvas.style.height = size + "px";
    
    ctx.scale(dpr, dpr);
    tileSize = size / GRID_COUNT;
  }

  window.addEventListener("resize", setupCanvas);

  /********* Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª Ø§Ù„Ù…ØªØ·ÙˆØ± *********/
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let audio;
  function playNote(f, d, type="sine", v=0.1) {
    if(!audio) audio = new AudioCtx();
    const o = audio.createOscillator(), g = audio.createGain();
    o.type = type; o.frequency.value = f;
    g.gain.setValueAtTime(v, audio.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, audio.currentTime + d);
    o.connect(g); g.connect(audio.destination);
    o.start(); o.stop(audio.currentTime + d);
  }

  const sfx = {
    eat: () => playNote(440, 0.1, "square"),
    mega: () => { [523, 659, 783, 1046].forEach((f,i) => playNote(f, 0.5, "triangle", 0.15, audio.currentTime + i*0.1)) },
    fail: () => { [300, 200, 100].forEach((f,i) => playNote(f, 0.4, "sawtooth", 0.2)) }
  };

  /********* Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„Ø¹Ø¨Ø© *********/
  function spawnItems() {
    const free = [];
    for(let y=0; y<GRID_COUNT; y++) {
      for(let x=0; x<GRID_COUNT; x++) {
        if(!state.snake.some(s => s.x === x && s.y === y)) free.push({x, y});
      }
    }
    const pos = free[Math.floor(Math.random()*free.length)];
    state.food = { ...pos, type: ["ğŸ‘Ÿ","ğŸ‘","ğŸ¥¾"][Math.floor(Math.random()*3)] };

    // ÙØ±ØµØ© Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© 20%
    state.bonus = Math.random() < 0.2 ? { ...free[Math.floor(Math.random()*free.length)], time: 5000 } : null;
    
    // ÙØ±ØµØ© Ø¸Ù‡ÙˆØ± Ø§Ù„ØºØ§Ø¦Ø· Ø§Ù„Ø¹Ù…Ù„Ø§Ù‚ 5%
    if(Math.random() < 0.05 && !state.megaBonus) {
      state.megaBonus = { ...free[Math.floor(Math.random()*free.length)], time: 7000 };
    }
  }

  function update() {
    if(!state.running || state.paused) return;

    state.dir = state.nextDir;
    const head = { x: (state.snake[0].x + state.dir.x + GRID_COUNT) % GRID_COUNT, 
                   y: (state.snake[0].y + state.dir.y + GRID_COUNT) % GRID_COUNT };

    if(state.snake.some(s => s.x === head.x && s.y === head.y)) return gameOver();

    state.snake.unshift(head);
    let ate = false;

    // Ø£ÙƒÙ„ Ø§Ù„Ø­Ø°Ø§Ø¡
    if(head.x === state.food.x && head.y === state.food.y) {
      state.score += 10; state.eaten += 1;
      sfx.eat(); spawnItems(); ate = true;
    } 
    // Ø£ÙƒÙ„ Ø§Ù„ØºØ§Ø¦Ø· Ø§Ù„Ø¹Ø§Ø¯ÙŠ
    else if(state.bonus && head.x === state.bonus.x && head.y === state.bonus.y) {
      state.score += 50; state.eaten += 5;
      sfx.eat(); state.bonus = null; ate = true;
      showToast("ğŸ’© Ø®Ø±Ø¨ Ø­Ø¸Ùƒ! +5");
    }
    // Ø£ÙƒÙ„ Ø§Ù„ØºØ§Ø¦Ø· Ø§Ù„Ø¹Ù…Ù„Ø§Ù‚ (The Legend)
    else if(state.megaBonus && head.x === state.megaBonus.x && head.y === state.megaBonus.y) {
      state.score += 200; state.eaten += 20;
      sfx.mega(); state.megaBonus = null; ate = true;
      showToast("ğŸŒˆ ØºØ§Ø¦Ø· Ø£Ø³Ø·ÙˆÙˆÙˆØ±ÙŠ! +20", true);
    }

    if(!ate) state.snake.pop();
    if(state.eaten >= 50) win();

    document.getElementById("score").textContent = state.score.toString().padStart(3, '0');
    document.getElementById("eaten").textContent = state.eaten;
  }

  function draw(time) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Ø±Ø³Ù… Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¨Ø¯Ù‚Ø©
    ctx.strokeStyle = "rgba(255,255,255,0.03)";
    for(let i=0; i<=GRID_COUNT; i++) {
      ctx.beginPath(); ctx.moveTo(i*tileSize, 0); ctx.lineTo(i*tileSize, canvas.height); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(0, i*tileSize); ctx.lineTo(canvas.width, i*tileSize); ctx.stroke();
    }

    // Ø±Ø³Ù… Ø§Ù„Ø·Ø¹Ø§Ù…
    ctx.font = `${tileSize*0.8}px Arial`;
    ctx.textAlign = "center"; ctx.textBaseline = "middle";
    ctx.fillText(state.food.type, (state.food.x+0.5)*tileSize, (state.food.y+0.5)*tileSize);

    // Ø±Ø³Ù… Ø§Ù„ØºØ§Ø¦Ø· Ø§Ù„Ø¹Ø§Ø¯ÙŠ
    if(state.bonus) {
      ctx.fillText("ğŸ’©", (state.bonus.x+0.5)*tileSize, (state.bonus.y+0.5)*tileSize);
    }

    // Ø±Ø³Ù… Ø§Ù„ØºØ§Ø¦Ø· Ø§Ù„Ø¹Ù…Ù„Ø§Ù‚ (Ø´Ø¹Ø§Ø¹ÙŠ ÙˆÙ…Ù„ÙˆÙ†)
    if(state.megaBonus) {
      const glow = Math.sin(time/100)*10 + 20;
      ctx.shadowBlur = glow;
      ctx.shadowColor = `hsl(${time%360}, 100%, 50%)`;
      ctx.font = `${tileSize * 1.5}px Arial`; // Ø­Ø¬Ù… Ø¶Ø®Ù…
      ctx.fillText("ğŸ’©", (state.megaBonus.x+0.5)*tileSize, (state.megaBonus.y+0.5)*tileSize);
      ctx.shadowBlur = 0;
    }

    // Ø±Ø³Ù… Ø§Ù„ÙƒÙ„Ø¨ (Ø§Ù„Ø¯ÙˆØ¯Ø©)
    state.snake.forEach((s, i) => {
      const x = s.x * tileSize, y = s.y * tileSize;
      ctx.fillStyle = i === 0 ? "#ff9800" : `rgba(210, 105, 30, ${1 - i/state.snake.length})`;
      
      if(i === 0) { // Ø§Ù„Ø±Ø£Ø³
        ctx.beginPath();
        ctx.roundRect(x+2, y+2, tileSize-4, tileSize-4, 8);
        ctx.fill();
        // Ø¹ÙŠÙˆÙ†
        ctx.fillStyle = "white";
        ctx.fillRect(x+tileSize*0.2, y+tileSize*0.2, 4, 4);
        ctx.fillRect(x+tileSize*0.6, y+tileSize*0.2, 4, 4);
      } else { // Ø§Ù„Ø¬Ø³Ù… Ø§Ù„Ù…ØªÙ…ÙˆØ¬
        const shift = Math.sin(time/200 + i)*2;
        ctx.beginPath();
        ctx.arc(x+tileSize/2 + shift, y+tileSize/2, tileSize/2.5, 0, Math.PI*2);
        ctx.fill();
      }
    });

    if(state.running) setTimeout(() => requestAnimationFrame(draw), 1000/60);
  }

  /********* ÙˆØ¸Ø§Ø¦Ù Ø¥Ø¶Ø§ÙÙŠØ© *********/
  function startGame() {
    state = {
      snake: [{x:10, y:10}, {x:9, y:10}, {x:8, y:10}],
      dir: {x:1, y:0}, nextDir: {x:1, y:0},
      score: 0, eaten: 0, speed: 120,
      running: true, paused: false
    };
    document.getElementById("overlay").style.display = "none";
    spawnItems();
    setupCanvas();
    gameLoop();
    requestAnimationFrame(draw);
  }

  function gameLoop() {
    if(!state.running) return;
    update();
    setTimeout(gameLoop, state.speed);
  }

  function gameOver() {
    state.running = false;
    sfx.fail();
    document.getElementById("title").textContent = "Ø·Ø§Ø­ Ø­Ø¸Ùƒ ÙŠØ§ Ø¨ÙƒØ±! ğŸ˜‚";
    document.getElementById("overlay").style.display = "flex";
  }

  function win() {
    state.running = false;
    sfx.mega();
    document.getElementById("title").textContent = "Ø¹ÙÙŠØ© Ø¨ÙƒÙˆØ±ÙŠ Ø§Ù„Ø¬Ø­Ø´! ğŸ‰";
    document.getElementById("overlay").style.display = "flex";
  }

  function showToast(msg, isMega=false) {
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.style.background = isMega ? "linear-gradient(45deg, #ff00cc, #3333ff)" : "var(--accent)";
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 2000);
  }

  function setDir(x, y) {
    if(state.dir.x !== -x && state.dir.y !== -y) state.nextDir = {x, y};
  }

  function toggleFullScreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
    } else {
      document.exitFullscreen();
    }
  }

  // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
  document.getElementById("startBtn").onclick = startGame;
  document.getElementById("btnUp").onclick = () => setDir(0, -1);
  document.getElementById("btnDown").onclick = () => setDir(0, 1);
  document.getElementById("btnLeft").onclick = () => setDir(-1, 0);
  document.getElementById("btnRight").onclick = () => setDir(1, 0);
  document.getElementById("pauseBtn").onclick = () => state.paused = !state.paused;

  // Ø¯Ø¹Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
  window.addEventListener("keydown", e => {
    if(e.key === "ArrowUp") setDir(0,-1);
    if(e.key === "ArrowDown") setDir(0,1);
    if(e.key === "ArrowLeft") setDir(-1,0);
    if(e.key === "ArrowRight") setDir(1,0);
  });

  setupCanvas();
</script>
</body>
</html>
