<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>Ù„Ø¹Ø¨Ø© Ø¨ÙƒØ± Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠØ© ğŸ¶</title>
  <style>
    :root {
      --primary: #00e676; /* Ù„ÙˆÙ† Ø£Ø®Ø¶Ø± Ø³Ø§Ø·Ø¹ */
      --secondary: #2979ff;
      --accent: #ff3d00;
      --bg: #121212;
      --glass: rgba(30, 30, 40, 0.85);
      --text-glow: 0 0 10px rgba(255,255,255,0.5);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
    
    body {
      margin: 0; padding: 0;
      background: var(--bg);
      color: #fff;
      font-family: 'Segoe UI', 'Roboto', sans-serif;
      height: 100vh; height: 100dvh; /* Ø¯Ø¹Ù… Ø£ÙØ¶Ù„ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
      overflow: hidden;
      display: flex; flex-direction: column;
    }

    /* Ø®Ù„ÙÙŠØ© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© */
    body::before {
      content: ""; position: absolute; inset: 0;
      background: 
        radial-gradient(circle at 20% 30%, #1a237e 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, #004d40 0%, var(--bg) 100%);
      z-index: -2; opacity: 0.5;
    }

    /* ØªØ£Ø«ÙŠØ± Ø§Ù‡ØªØ²Ø§Ø² Ø§Ù„Ø´Ø§Ø´Ø© */
    @keyframes shake {
      0% { transform: translate(1px, 1px) rotate(0deg); }
      10% { transform: translate(-1px, -2px) rotate(-1deg); }
      20% { transform: translate(-3px, 0px) rotate(1deg); }
      30% { transform: translate(3px, 2px) rotate(0deg); }
      40% { transform: translate(1px, -1px) rotate(1deg); }
      50% { transform: translate(-1px, 2px) rotate(-1deg); }
      60% { transform: translate(-3px, 1px) rotate(0deg); }
      100% { transform: translate(1px, -2px) rotate(-1deg); }
    }
    .shake-screen { animation: shake 0.5s; }

    /* HUD - ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù†Ù‚Ø§Ø· */
    .hud {
      display: flex; justify-content: space-between;
      padding: 15px 25px; background: var(--glass);
      backdrop-filter: blur(15px);
      border-bottom: 2px solid rgba(255,255,255,0.05);
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      z-index: 10;
    }

    .stat-box { display: flex; flex-direction: column; align-items: center; }
    .stat-label { font-size: 12px; color: #ccc; letter-spacing: 1px; margin-bottom: 4px;}
    .stat-value { font-size: 24px; font-weight: 900; text-shadow: var(--text-glow); color: var(--primary); }

    /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø© */
    .game-wrap {
      flex: 1; position: relative;
      display: flex; align-items: center; justify-content: center;
      padding: 20px 10px; /* Ù…Ø³Ø§Ø­Ø© Ø­ÙˆÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© */
    }

    canvas {
      border-radius: 16px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.6), inset 0 0 20px rgba(255,255,255,0.05);
      background: rgba(0,0,0,0.2); /* Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
    }

    /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ­ÙƒÙ… */
    .controls-container {
      padding: 20px 20px 50px 20px; /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ù„Ø±ÙØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
      background: linear-gradient(to top, var(--glass), transparent);
      display: flex; justify-content: center; align-items: center;
      gap: 40px;
      backdrop-filter: blur(5px);
    }

    .d-pad-grid {
      display: grid; grid-template-columns: repeat(3, 75px); grid-template-rows: repeat(2, 70px); gap: 8px;
    }

    .btn-ctrl {
      background: rgba(255,255,255,0.07);
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 18px; color: white; font-size: 32px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.1s cubic-bezier(0.4, 0.0, 0.2, 1);
      box-shadow: 0 4px 0 rgba(0,0,0,0.3);
    }
    .btn-ctrl:active { background: var(--primary); transform: translateY(4px); box-shadow: none; color: #000;}
    
    /* ØªÙ†Ø³ÙŠÙ‚ Ø§ØªØ¬Ø§Ù‡Ø§Øª Ù‚ÙŠØ§Ø³ÙŠ */
    #btnUp { grid-column: 2; grid-row: 1; }
    #btnLeft { grid-column: 1; grid-row: 2; }
    #btnDown { grid-column: 2; grid-row: 2; }
    #btnRight { grid-column: 3; grid-row: 2; }

    /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
    .overlay {
      position: absolute; inset: 0; background: rgba(0,0,0,0.85);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 100; text-align: center; padding: 30px;
      backdrop-filter: blur(8px);
    }
    
    /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù„Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ */
    #startOverlay { z-index: 200; background: #000; }

    .card-panel {
      background: linear-gradient(145deg, rgba(40,40,50,0.9), rgba(20,20,30,0.9));
      padding: 40px; border-radius: 30px;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      max-width: 450px; width: 100%; animation: floatCard 3s ease-in-out infinite alternate;
    }
    @keyframes floatCard { from { transform: translateY(0); } to { transform: translateY(-10px); } }

    h1 { margin: 0 0 15px; font-size: 2.5em; background: linear-gradient(to right, #fff, var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .highlight { color: var(--primary); font-weight: bold; }

    .btn-action {
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      border: none; padding: 18px 50px; border-radius: 50px;
      color: #fff; font-weight: 900; font-size: 22px; cursor: pointer;
      margin-top: 25px; width: 100%; text-transform: uppercase; letter-spacing: 1px;
      box-shadow: 0 10px 30px -10px var(--secondary); transition: 0.3s;
    }
    .btn-action:hover { transform: scale(1.05); box-shadow: 0 15px 40px -10px var(--primary); }

    .toast-msg {
      position: absolute; top: 15%; left: 50%; transform: translateX(-50%) scale(0.8);
      background: rgba(0,0,0,0.8); padding: 12px 24px; border-radius: 30px;
      font-weight: 800; font-size: 18px; border: 2px solid var(--primary);
      opacity: 0; pointer-events: none; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 50;
    }
    .toast-msg.show { opacity: 1; transform: translateX(-50%) scale(1); top: 18%; }

  </style>
</head>
<body id="mainBody">

<div id="startOverlay" class="overlay">
  <div class="card-panel" style="cursor: pointer;" onclick="initAudioAndShowMenu()">
      <h1 style="font-size: 4em;">ğŸ”Š</h1>
      <h1>Ø§Ø¶ØºØ· Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª</h1>
      <p>Ø§Ù„Ù…ØªØµÙØ­ ÙŠØ­ØªØ§Ø¬ Ø¥Ø°Ù†Ùƒ Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰</p>
  </div>
</div>

<div class="hud">
  <div class="stat-box">
    <span class="stat-label">Ø§Ù„Ù†ØªÙŠØ¬Ø©</span>
    <span id="scoreLbl" class="stat-value">0</span>
  </div>
  <div class="stat-box">
    <span class="stat-label">Ø§Ù„Ø£Ø­Ø°ÙŠØ© Ø§Ù„Ù…Ø£ÙƒÙˆÙ„Ø© ğŸ‘Ÿ</span>
    <span id="eatenLbl" class="stat-value">0</span>
  </div>
</div>

<div class="game-wrap" id="gameWrapper">
  <canvas id="gameCanvas"></canvas>
  <div id="toastBox" class="toast-msg"></div>

  <div id="menuOverlay" class="overlay" style="display: none;">
    <div class="card-panel">
      <h1 id="menuTitle">ğŸ¶ Ø³ÙˆØ¨Ø± Ø¨ÙƒØ± Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠ</h1>
      <p style="color: #ccc; font-size: 16px; line-height: 1.8;">
        Ù‚Ù… Ø¨ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„ÙƒÙ„Ø¨ "Ø¨ÙƒØ±" Ù„ÙŠØ£ÙƒÙ„ Ø§Ù„Ø£Ø­Ø°ÙŠØ©.<br>
        Ø§Ø­Ø°Ø± Ù…Ù† Ø§Ù„Ø§ØµØ·Ø¯Ø§Ù… Ø¨Ù†ÙØ³Ùƒ!<br>
        Ø§Ø¨Ø­Ø« Ø¹Ù† <span class="highlight" style="color:#ffd700">Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©</span> Ø§Ù„Ù†Ø§Ø¯Ø±Ø©.
      </p>
      <button id="playBtn" class="btn-action">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨</button>
    </div>
  </div>
</div>

<div class="controls-container">
  <div class="d-pad-grid">
    <div id="btnUp" class="btn-ctrl">â¬†ï¸</div>
    <div id="btnLeft" class="btn-ctrl">â¬…ï¸</div>
    <div id="btnDown" class="btn-ctrl">â¬‡ï¸</div>
    <div id="btnRight" class="btn-ctrl">â¡ï¸</div>
  </div>
</div>

<script>
  // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø±Ùƒ ---
  const GRID_SIZE = 22; // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª
  let TILE = 0; // Ø­Ø¬Ù… Ø§Ù„Ù…Ø±Ø¨Ø¹ (ÙŠØªÙ… Ø­Ø³Ø§Ø¨Ù‡)
  
  // Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
  let gameState = {
    snake: [], 
    dir: {x:1, y:0}, // Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„Ù„ÙŠÙ…ÙŠÙ†
    nextDir: {x:1, y:0},
    food: null, bonus: null,
    score: 0, eaten: 0,
    speed: 110, // Ø³Ø±Ø¹Ø© Ù…ØªÙˆØ³Ø·Ø©
    isRunning: false,
    startTime: 0
  };

  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d", { alpha: false }); // ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡

  // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø­Ø³Ù† (Web Audio API) ---
  let audioCtx;
  let bgmOscillators = []; // Ù„Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ©
  let isAudioInit = false;

  // Ø¯Ø§Ù„Ø© Ù„ØªØ´ØºÙŠÙ„ Ù†ØºÙ…Ø© Ù‚ØµÙŠØ±Ø© (Ù…Ø¤Ø«Ø±Ø§Øª)
  function sfx(freq, duration, type="sine", vol=0.2, detune=0) {
    if(!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type; osc.frequency.value = freq; osc.detune.value = detune;
    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + duration);
  }

  // ØªØ´ØºÙŠÙ„ Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø®Ù„ÙÙŠØ© Ø¨Ø³ÙŠØ·Ø© ÙˆÙ…ØªÙƒØ±Ø±Ø©
  function startBGM() {
      if(!audioCtx) return;
      stopBGM(); // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø³Ø§Ø¨Ù‚Ø©
      
      // Ø®Ø· Ø¨Ø§Øµ (Bassline) Ø¨Ø³ÙŠØ·
      const bass = audioCtx.createOscillator();
      const bassGain = audioCtx.createGain();
      bass.type = 'triangle';
      bass.frequency.setValueAtTime(110, audioCtx.currentTime); // A2
      bassGain.gain.setValueAtTime(0.08, audioCtx.currentTime);
      bass.connect(bassGain); bassGain.connect(audioCtx.destination);
      bass.start();
      bgmOscillators.push(bass);
      
      // Ø¥ÙŠÙ‚Ø§Ø¹ Ø¨Ø³ÙŠØ· (Ù†ØºÙ…Ø© ØªØªÙƒØ±Ø± ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©)
      setInterval(() => {
          if(audioCtx.state === 'running') {
               sfx(440, 0.05, "square", 0.02); // ØªÙŠÙƒ Ø®ÙÙŠÙ
          }
      }, 1000);
  }

  function stopBGM() {
      bgmOscillators.forEach(osc => osc.stop());
      bgmOscillators = [];
  }
  
  // Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ù„Ù„ØµÙˆØª
  function initAudioAndShowMenu() {
      if (!isAudioInit) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          // ØªØ´ØºÙŠÙ„ Ù†ØºÙ…Ø© ÙØ§Ø±ØºØ© Ù„ÙÙƒ Ø§Ù„Ø­Ø¸Ø±
          sfx(0,0, 'sine', 0); 
          isAudioInit = true;
          startBGM(); // Ø¨Ø¯Ø¡ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ© ÙÙˆØ±Ø§Ù‹
      }
      document.getElementById("startOverlay").style.display = "none";
      document.getElementById("menuOverlay").style.display = "flex";
      resizeGame();
  }


  // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© (Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠØ©) ---
  
  // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø±Ø³Ù… Ø´ÙƒÙ„ Ø¨ÙŠØ¶ÙˆÙŠ Ù…Ø¯ÙˆØ±
  function drawRoundedEllipse(ctx, x, y, w, h, color, rotation=0) {
      ctx.save();
      ctx.translate(x, y);
      ctx.rotate(rotation);
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.ellipse(0, 0, w/2, h/2, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
  }

  function drawRealisticSnake(time) {
    // Ø±Ø³Ù… Ø§Ù„Ø¬Ø³Ù… Ù…Ù† Ø§Ù„Ø°ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø£Ø³
    for (let i = gameState.snake.length - 1; i >= 0; i--) {
      const segment = gameState.snake[i];
      const cx = (segment.x + 0.5) * TILE;
      const cy = (segment.y + 0.5) * TILE;
      
      // Ø­Ø³Ø§Ø¨ Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¯ÙˆØ±Ø§Ù† Ù„Ù„Ù‚Ø·Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø·Ø¹Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
      let angle = 0;
      if (i > 0) {
          const prev = gameState.snake[i-1];
          const dx = prev.x - segment.x;
          const dy = prev.y - segment.y;
          // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø§Ù„ØªÙØ§Ù Ø­ÙˆÙ„ Ø§Ù„Ø´Ø§Ø´Ø©
          if(Math.abs(dx) > 1 || Math.abs(dy) > 1) angle = Math.atan2(-dy, -dx);
          else angle = Math.atan2(dy, dx);
      } else {
          angle = Math.atan2(gameState.dir.y, gameState.dir.x);
      }

      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(angle);

      if (i === 0) {
        // --- Ø±Ø³Ù… Ø±Ø£Ø³ Ø§Ù„ÙƒÙ„Ø¨ Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠ ---
        const headSize = TILE * 1.3;
        
        // Ø§Ù„ÙØ±Ùˆ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (ØªØ¯Ø±Ø¬ Ù„ÙˆÙ†ÙŠ)
        const furGrad = ctx.createRadialGradient(0, 0, headSize*0.2, 0, 0, headSize*0.6);
        furGrad.addColorStop(0, "#D9A575"); /* Ø¨Ù†ÙŠ Ø°Ù‡Ø¨ÙŠ ÙØ§ØªØ­ */
        furGrad.addColorStop(1, "#8D5524"); /* Ø¨Ù†ÙŠ ØºØ§Ù…Ù‚ Ù„Ù„Ø£Ø·Ø±Ø§Ù */
        
        // Ø´ÙƒÙ„ Ø§Ù„Ø±Ø£Ø³ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
        drawRoundedEllipse(ctx, 0, 0, headSize, headSize*0.85, furGrad);

        // Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙÙ… ÙˆØ§Ù„Ø£Ù†Ù (Snout) - Ù„ÙˆÙ† Ø£ÙØªØ­
        drawRoundedEllipse(ctx, headSize*0.25, 0, headSize*0.5, headSize*0.4, "#EBD2B4");

        // Ø§Ù„Ø£Ù†Ù
        drawRoundedEllipse(ctx, headSize*0.45, 0, headSize*0.18, headSize*0.12, "#3E2723");
        
        // Ø§Ù„Ø¹ÙŠÙˆÙ†
        const eyeY = -headSize*0.15;
        const eyeX = headSize*0.1;
        // Ø¨ÙŠØ§Ø¶ Ø§Ù„Ø¹ÙŠÙ†
        drawRoundedEllipse(ctx, eyeX, eyeY, headSize*0.15, headSize*0.15, "white");
        drawRoundedEllipse(ctx, eyeX, -eyeY, headSize*0.15, headSize*0.15, "white");
        // Ø­Ø¯Ù‚Ø© Ø§Ù„Ø¹ÙŠÙ†
        drawRoundedEllipse(ctx, eyeX+2, eyeY, headSize*0.08, headSize*0.08, "#000");
        drawRoundedEllipse(ctx, eyeX+2, -eyeY, headSize*0.08, headSize*0.08, "#000");

        // Ø§Ù„Ø£Ø°Ù†ÙŠÙ† (Ù…ØªØ­Ø±ÙƒØ© Ù‚Ù„ÙŠÙ„Ø§Ù‹)
        const earWag = Math.sin(time / 150) * 0.05;
        ctx.fillStyle = "#6D4C41"; // Ù„ÙˆÙ† Ø§Ù„Ø£Ø°Ù† Ø§Ù„ØºØ§Ù…Ù‚
        // Ø£Ø°Ù† ÙŠØ³Ø±Ù‰
        ctx.beginPath();
        ctx.ellipse(-headSize*0.2, -headSize*0.35, headSize*0.15, headSize*0.3, -0.3 + earWag, 0, Math.PI*2);
        ctx.fill();
        // Ø£Ø°Ù† ÙŠÙ…Ù†Ù‰
        ctx.beginPath();
        ctx.ellipse(-headSize*0.2, headSize*0.35, headSize*0.15, headSize*0.3, 0.3 - earWag, 0, Math.PI*2);
        ctx.fill();

        // --- Ø±Ø³Ù… Ø§Ù„Ø§Ø³Ù… "Ø¨ÙƒØ±" Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø£Ø³ ---
        ctx.fillStyle = "white";
        ctx.strokeStyle = "black";
        ctx.lineWidth = TILE * 0.05;
        ctx.font = `bold ${TILE * 0.35}px Tahoma`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        
        // Ù†Ø¯ÙˆØ± Ø§Ù„Ù†Øµ 90 Ø¯Ø±Ø¬Ø© Ù„ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø£Ø³ (Ù„Ø£Ù† Ø§Ù„Ø±Ø£Ø³ Ù…ØªØ¬Ù‡ Ù„Ù„ÙŠÙ…ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹)
        ctx.rotate(Math.PI / 2); 
        // Ø±Ø³Ù… Ø§Ù„Ù†Øµ ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø±Ø£Ø³ ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹
        ctx.strokeText("Ø¨ÙƒØ±", 0, -headSize*0.1);
        ctx.fillText("Ø¨ÙƒØ±", 0, -headSize*0.1);

      } else {
        // --- Ø±Ø³Ù… Ø§Ù„Ø¬Ø³Ù… Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠ (Ø¬Ù„Ø¯ Ù…ØªØµÙ„) ---
        const bodySize = TILE * 0.9;
        // ØªØ¯Ø±Ø¬ Ù„ÙˆÙ†ÙŠ Ù„Ù„Ø¬Ø³Ù… ÙŠØ¹Ø·ÙŠ Ø¹Ù…Ù‚Ø§Ù‹
        const bodyGrad = ctx.createLinearGradient(-bodySize/2, -bodySize/2, bodySize/2, bodySize/2);
        bodyGrad.addColorStop(0, i%2===0 ? "#A16A3A" : "#B87F4B"); // ØªÙ†Ø§ÙˆØ¨ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø¨Ù†ÙŠ
        bodyGrad.addColorStop(1, "#6D4C41"); // Ø¸Ù„ ØºØ§Ù…Ù‚

        // Ø±Ø³Ù… Ù‚Ø·Ø¹Ø© Ø§Ù„Ø¬Ø³Ù… Ø¨Ø´ÙƒÙ„ Ø¨ÙŠØ¶ÙˆÙŠ Ù…Ù…Ø¯ÙˆØ¯ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„Ø§ØªØµØ§Ù„
        drawRoundedEllipse(ctx, 0, 0, bodySize*1.1, bodySize*0.8, bodyGrad);
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ù…Ø³ Ø¨Ø³ÙŠØ· (Ù†Ù‚Ø§Ø·)
        ctx.fillStyle = "rgba(0,0,0,0.15)";
        ctx.beginPath(); ctx.arc(bodySize*0.2, -bodySize*0.2, bodySize*0.05, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(-bodySize*0.1, bodySize*0.15, bodySize*0.08, 0, Math.PI*2); ctx.fill();
      }
      
      ctx.restore();
    }
  }

  function drawItems(time) {
    // Ø±Ø³Ù… Ø§Ù„Ø·Ø¹Ø§Ù… (Ø­Ø°Ø§Ø¡)
    if(gameState.food) {
        const pulse = 1 + Math.sin(time * 0.008) * 0.1;
        ctx.font = `${TILE * 1.1 * pulse}px Arial`;
        ctx.textAlign = "center"; ctx.textBaseline = "middle";
        // Ø¸Ù„ Ø®ÙÙŠÙ ØªØ­Øª Ø§Ù„Ø­Ø°Ø§Ø¡
        ctx.fillStyle = "rgba(0,0,0,0.3)";
        ctx.fillText(gameState.food.type, (gameState.food.x+0.5)*TILE, (gameState.food.y+0.6)*TILE);
        // Ø§Ù„Ø­Ø°Ø§Ø¡ Ù†ÙØ³Ù‡
        ctx.fillText(gameState.food.type, (gameState.food.x+0.5)*TILE, (gameState.food.y+0.5)*TILE);
    }
    
    // Ø±Ø³Ù… Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© (ØºØ§Ø¦Ø· Ø°Ù‡Ø¨ÙŠ Ù…Ø´Ø¹)
    if(gameState.bonus) {
        const x = (gameState.bonus.x+0.5)*TILE;
        const y = (gameState.bonus.y+0.5)*TILE;
        
        // Ù‡Ø§Ù„Ø© Ù…Ø´Ø¹Ø©
        const glowSize = TILE * (1 + Math.sin(time * 0.02) * 0.3);
        const glow = ctx.createRadialGradient(x, y, TILE*0.2, x, y, glowSize);
        glow.addColorStop(0, "rgba(255, 215, 0, 0.8)");
        glow.addColorStop(1, "rgba(255, 215, 0, 0)");
        ctx.fillStyle = glow;
        ctx.beginPath(); ctx.arc(x, y, glowSize, 0, Math.PI*2); ctx.fill();

        ctx.font = `${TILE * 1.4}px Arial`;
        ctx.fillText("ğŸ’©", x, y);
    }
  }


  // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„Ø¹Ø¨Ø© ---
  function update() {
    if(!gameState.isRunning) return;

    gameState.dir = gameState.nextDir;
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø±Ø£Ø³ Ù…Ø¹ Ø§Ù„Ø§Ù„ØªÙØ§Ù Ø­ÙˆÙ„ Ø§Ù„Ø´Ø§Ø´Ø© (Wrap-around)
    let nx = (gameState.snake[0].x + gameState.dir.x + GRID_SIZE) % GRID_SIZE;
    let ny = (gameState.snake[0].y + gameState.dir.y + GRID_SIZE) % GRID_SIZE;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØµØ·Ø¯Ø§Ù… Ø¨Ø§Ù„Ø¬Ø³Ù…
    // Ù†Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚Ø·Ø¹Ø© Ø±Ù‚Ù… 3 Ù„Ø£Ù† Ø§Ù„Ø±Ø£Ø³ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„Ø§ØµØ·Ø¯Ø§Ù… Ø¨Ø§Ù„Ø±Ù‚Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
    for(let i = 3; i < gameState.snake.length; i++) {
        if(gameState.snake[i].x === nx && gameState.snake[i].y === ny) {
            return gameOver();
        }
    }

    const newHead = {x: nx, y: ny};
    gameState.snake.unshift(newHead); // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙŠØ¯

    let ate = false;

    // Ø£ÙƒÙ„ Ø§Ù„Ø·Ø¹Ø§Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ
    if (gameState.food && nx === gameState.food.x && ny === gameState.food.y) {
        gameState.score += 10;
        gameState.eaten++;
        // ØµÙˆØª Ø£ÙƒÙ„ + Ù†Ø¨Ø§Ø­ Ø®ÙÙŠÙ
        sfx(500, 0.1, 'square'); setTimeout(()=>sfx(300, 0.15, 'sawtooth', 0.3), 100);
        showToast("ğŸ‘Ÿ ÙŠÙ… ÙŠÙ…!", false);
        spawnFood();
        ate = true;
        // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ø±Ø¹Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹ ÙƒÙ„ 5 Ø£ÙƒÙ„Ø§Øª
        if(gameState.eaten % 5 === 0 && gameState.speed > 70) gameState.speed -= 4;
    }
    
    // Ø£ÙƒÙ„ Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰
    else if(gameState.bonus && nx === gameState.bonus.x && ny === gameState.bonus.y) {
        gameState.score += 100;
        gameState.eaten += 5;
        // Ø§Ù‡ØªØ²Ø§Ø² Ø§Ù„Ø´Ø§Ø´Ø©
        document.getElementById('mainBody').classList.add('shake-screen');
        setTimeout(()=>document.getElementById('mainBody').classList.remove('shake-screen'), 500);
        // ØµÙˆØª Ø§Ù†ØªØµØ§Ø±
        [600, 800, 1000].forEach((f,i) => setTimeout(()=>sfx(f, 0.2, 'triangle', 0.4), i*100));
        showToast("ğŸŒŸ Ø¬Ø§Ø¦Ø²Ø© Ø£Ø³Ø·ÙˆØ±ÙŠØ©! +100", true);
        gameState.bonus = null;
        ate = true;
    }

    if(!ate) gameState.snake.pop(); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø°ÙŠÙ„ Ø¥Ø°Ø§ Ù„Ù… ÙŠØ£ÙƒÙ„

    updateHUD();
  }

  function gameLoop(timeStamp) {
    // Ø±Ø³Ù… Ø§Ù„Ø®Ù„ÙÙŠØ© (Ù„ÙˆÙ† Ø¯Ø§ÙƒÙ† ÙŠØºØ·ÙŠ Ø§Ù„Ø¥Ø·Ø§Ø±Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©)
    ctx.fillStyle = "#1a1a24"; 
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Ø±Ø³Ù… Ø´Ø¨ÙƒØ© Ø®ÙÙŠÙØ© Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ø£Ø±Ø¶ÙŠØ©
    ctx.strokeStyle = "rgba(255,255,255,0.04)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    for(let i=0; i<=GRID_SIZE; i++) {
        ctx.moveTo(i*TILE, 0); ctx.lineTo(i*TILE, canvas.height);
        ctx.moveTo(0, i*TILE); ctx.lineTo(canvas.width, i*TILE);
    }
    ctx.stroke();

    if (timeStamp - gameState.startTime > gameState.speed) {
        update();
        gameState.startTime = timeStamp;
    }
    
    drawItems(timeStamp);
    drawRealisticSnake(timeStamp);
    
    if(gameState.isRunning) requestAnimationFrame(gameLoop);
  }


  // --- Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ---
  function spawnFood() {
    let pos = getFreePosition();
    gameState.food = { ...pos, type: ["ğŸ‘Ÿ","ğŸ‘","ğŸ¥¾"][Math.floor(Math.random()*3)] };
    // Ø§Ø­ØªÙ…Ø§Ù„ 15% Ù„Ø¸Ù‡ÙˆØ± Ø¬Ø§Ø¦Ø²Ø©
    if(Math.random() < 0.15 && !gameState.bonus) {
        let bonusPos = getFreePosition();
        gameState.bonus = { ...bonusPos, spawnTime: performance.now() };
        // ØªØ®ØªÙÙŠ Ø¨Ø¹Ø¯ 6 Ø«ÙˆØ§Ù†ÙŠ
        setTimeout(() => { if(gameState.bonus && gameState.bonus.x === bonusPos.x) gameState.bonus = null; }, 6000);
    }
  }

  function getFreePosition() {
      let x, y, isFree;
      do {
          x = Math.floor(Math.random() * GRID_SIZE);
          y = Math.floor(Math.random() * GRID_SIZE);
          isFree = !gameState.snake.some(s => s.x === x && s.y === y) && 
                   (!gameState.food || (gameState.food.x !== x || gameState.food.y !== y));
      } while(!isFree);
      return {x, y};
  }

  function startGame() {
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø©
    gameState.snake = [{x: Math.floor(GRID_SIZE/2), y: Math.floor(GRID_SIZE/2)}]; // Ø§Ø¨Ø¯Ø£ Ø¨Ù‚Ø·Ø¹Ø© ÙˆØ§Ø­Ø¯Ø© (Ø§Ù„Ø±Ø£Ø³)
    // Ø¥Ø¶Ø§ÙØ© Ø¬Ø³Ù… Ù…Ø¨Ø¯Ø¦ÙŠ Ø®Ù„Ù Ø§Ù„Ø±Ø£Ø³
    gameState.snake.push({x: gameState.snake[0].x-1, y: gameState.snake[0].y});
    gameState.snake.push({x: gameState.snake[0].x-2, y: gameState.snake[0].y});
    
    gameState.dir = {x:1, y:0}; gameState.nextDir = {x:1, y:0};
    gameState.score = 0; gameState.eaten = 0; gameState.speed = 110;
    gameState.bonus = null; gameState.isRunning = true;
    
    updateHUD();
    spawnFood();
    document.getElementById("menuOverlay").style.display = "none";
    gameState.startTime = performance.now();
    requestAnimationFrame(gameLoop);
  }

  function gameOver() {
    gameState.isRunning = false;
    // ØµÙˆØª Ø§Ù„Ø®Ø³Ø§Ø±Ø©
    sfx(150, 0.5, 'sawtooth', 0.5); sfx(100, 0.6, 'sine', 0.5, -50);
    
    document.getElementById("menuTitle").innerHTML = "ğŸ’¥ Ø§ØµØ·Ø¯Ù…Øª!";
    document.querySelector("#menuOverlay p").innerHTML = `Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: <span class="highlight">${gameState.score}</span><br>Ø£ÙƒÙ„ Ø¨ÙƒØ± ${gameState.eaten} Ø­Ø°Ø§Ø¡.`;
    document.getElementById("playBtn").textContent = "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©";
    document.getElementById("menuOverlay").style.display = "flex";
  }

  function resizeGame() {
    const wrapper = document.getElementById("gameWrapper");
    // Ù†Ø£Ø®Ø° Ø£ØµØºØ± Ø¨ÙØ¹Ø¯ (Ø¹Ø±Ø¶ Ø£Ùˆ Ø§Ø±ØªÙØ§Ø¹) ÙˆÙ†Ø·Ø±Ø­ Ù…Ù†Ù‡ Ø§Ù„Ù‡ÙˆØ§Ù…Ø´ Ù„Ù†Ø¬Ø¹Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ø±Ø¨Ø¹Ø©
    const size = Math.min(wrapper.clientWidth, wrapper.clientHeight) - 30;
    
    // Ø¯Ø¹Ù… Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø±ÙŠØªÙŠÙ†Ø§ (Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¯Ù‚Ø©) Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø³Ù… Ø­Ø§Ø¯
    const dpr = window.devicePixelRatio || 1;
    canvas.width = size * dpr;
    canvas.height = size * dpr;
    canvas.style.width = size + "px";
    canvas.style.height = size + "px";
    ctx.scale(dpr, dpr); // ØªÙƒØ¨ÙŠØ± Ø³ÙŠØ§Ù‚ Ø§Ù„Ø±Ø³Ù…
    
    TILE = size / GRID_SIZE; // Ø­Ø³Ø§Ø¨ Ø­Ø¬Ù… Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    
    if(!gameState.isRunning && isAudioInit) {
         // Ø±Ø³Ù… Ø¥Ø·Ø§Ø± ÙˆØ§Ø­Ø¯ Ø«Ø§Ø¨Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…ØªÙˆÙ‚ÙØ©
         drawRealisticSnake(0);
    }
  }

  function updateHUD() {
      document.getElementById("scoreLbl").textContent = gameState.score;
      document.getElementById("eatenLbl").textContent = gameState.eaten;
  }

  function showToast(msg, isImportant) {
      const t = document.getElementById("toastBox");
      t.textContent = msg;
      t.style.borderColor = isImportant ? "#ffd700" : "var(--primary)";
      t.style.color = isImportant ? "#ffd700" : "#fff";
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 2000);
  }


  // --- Ø§Ù„ØªØ­ÙƒÙ… ---
  function setDir(x, y) {
      // Ù…Ù†Ø¹ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø®Ù„Ù Ù…Ø¨Ø§Ø´Ø±Ø© (Ù…Ø«Ù„Ø§Ù‹ Ø¥Ø°Ø§ ÙƒÙ†Øª ØªÙ…Ø´ÙŠ ÙŠÙ…ÙŠÙ† Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¶ØºØ· ÙŠØ³Ø§Ø± ÙÙˆØ±Ø§Ù‹)
      if (gameState.dir.x !== -x && gameState.dir.y !== -y) {
          gameState.nextDir = {x, y};
          // ØµÙˆØª Ù†Ù‚Ø±Ø© Ø®ÙÙŠÙØ© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø§ØªØ¬Ø§Ù‡
          if(gameState.isRunning) sfx(800, 0.03, 'sine', 0.05);
      }
  }

  // Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± (Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ: ÙŠÙ…ÙŠÙ†=1ØŒ ÙŠØ³Ø§Ø±=-1)
  document.getElementById("btnUp").addEventListener('pointerdown', e => { e.preventDefault(); setDir(0, -1); });
  document.getElementById("btnDown").addEventListener('pointerdown', e => { e.preventDefault(); setDir(0, 1); });
  document.getElementById("btnLeft").addEventListener('pointerdown', e => { e.preventDefault(); setDir(-1, 0); });
  document.getElementById("btnRight").addEventListener('pointerdown', e => { e.preventDefault(); setDir(1, 0); });
  document.getElementById("playBtn").onclick = startGame;

  window.addEventListener("keydown", e => {
      if(["ArrowUp","w"].includes(e.key)) setDir(0, -1);
      if(["ArrowDown","s"].includes(e.key)) setDir(0, 1);
      if(["ArrowLeft","a"].includes(e.key)) setDir(-1, 0);
      if(["ArrowRight","d"].includes(e.key)) setDir(1, 0);
  });
  
  window.addEventListener("resize", resizeGame);

  // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆÙ„ÙŠ (Ù„Ù† ÙŠØ¨Ø¯Ø£ Ø­ØªÙ‰ ÙŠØ¶ØºØ· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰)
  // resizeGame() Ø³ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ø¯Ø§Ø®Ù„ initAudioAndShowMenu
</script>
</body>
</html>
