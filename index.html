<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¯ÙˆØ¯Ø© â€” Ù‡Ø¯Ù 50 Ø­Ø°Ø§Ø¡</title>
  <style>
    :root{
      --bg:#14161a;
      --panel:#1c2026;
      --accent:#00d0b0;
      --accent2:#ffd166;
      --danger:#ff4d4f;
      --text:#e8ecef;
      --snakeBorder:#083d2d;
      --snakeFill1:#1bc8a8;
      --snakeFill2:#0fb18c;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:radial-gradient(1000px 600px at 50% -10%, #222a33 0, var(--bg) 60%);
      color:var(--text); font-family:"Segoe UI", Tahoma, Arial, system-ui, -apple-system;
      display:flex; align-items:center; justify-content:center; min-height:100vh; padding:20px;
    }
    .wrap{ width:min(92vw, 720px); }
    h1{ margin:0 0 8px; font-size:clamp(20px, 3.2vw, 28px); }
    .sub{ margin:0 0 14px; color:#aeb8c4; font-size:14px; }

    .hud{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      background:linear-gradient(180deg, #1e232a 0, var(--panel) 100%);
      border:1px solid #2a3038; border-radius:12px; padding:10px 12px; margin-bottom:10px;
    }
    .stat{display:flex; gap:8px; align-items:baseline; font-weight:700}
    .v{color:var(--accent)}
    .btns{display:flex; gap:8px; flex-wrap:wrap}
    button{
      background:var(--accent); color:#002a24; border:none; border-radius:10px;
      padding:8px 14px; font-weight:800; cursor:pointer; transition:transform .05s ease;
    }
    button:active{transform:scale(.98)}
    button.sec{background:#2b3440; color:#e5eef5; border:1px solid #394352}

    .canvas-wrap{
      position:relative; border-radius:14px; overflow:hidden;
      border:1px solid #2a3038;
      box-shadow: 0 10px 24px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.03);
      background:#0f1216;
    }
    canvas{
      width:100%; height:auto; display:block;
      background:repeating-linear-gradient(0deg, #0f1216 0 24px, #11161c 24px 48px);
    }

    /* ØªÙˆØ³Øª Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­Ø© */
    .toast{
      position:absolute; top:10px; left:50%;
      transform:translateX(-50%) translateY(-12px);
      opacity:0; transition: opacity .25s ease, transform .25s ease;
      background:#15222b; color:#eaf6f3; border:1px solid #2a3038;
      padding:8px 14px; border-radius:999px; font-weight:800; letter-spacing:.2px;
      box-shadow:0 6px 18px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
      pointer-events:none;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }

    .overlay{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background:linear-gradient(180deg, rgba(20,22,26,.55), rgba(20,22,26,.75));
      backdrop-filter:saturate(120%) blur(2px);
      text-align:center; padding:20px;
    }
    .card{
      background:#11161c; border:1px solid #2a3038; border-radius:14px; padding:18px; max-width:540px;
    }
    .card h2{margin:0 0 8px}
    .tips{font-size:14px; color:#b7c3cf; line-height:1.6; text-align:justify}
    .grid-legend{display:flex; gap:10px; margin:10px 0 0; justify-content:center; flex-wrap:wrap}
    .legend-item{display:flex; gap:6px; align-items:center; background:#0e1318; padding:6px 10px; border-radius:8px; border:1px solid #26303a}
    .key{background:#222b35; border:1px solid #344150; border-radius:6px; padding:2px 6px; font-family:monospace; font-size:13px}

    /* Ø£Ø²Ø±Ø§Ø± Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    .mobile-ctrl{
      display:grid; grid-template-columns:60px 60px 60px; gap:8px; justify-content:center; margin:12px 0;
      touch-action:none; user-select:none;
    }
    .mobile-ctrl button{padding:12px 0; border-radius:12px}
    .empty{visibility:hidden}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ¶ğŸ Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¯ÙˆØ¯Ø© â€” Ù‡Ø¯ÙÙƒ 50 Ø­Ø°Ø§Ø¡</h1>
    <p class="sub">Ø¬Ø³Ù… Ø§Ù„Ø¯ÙˆØ¯Ø© Ø´ÙƒÙ„ Ø­ÙÙŠÙ‘Ø© Ø£ÙˆØ¶Ø­ØŒ Ø§Ù„Ø£Ø­Ø°ÙŠØ© Ø£ÙƒØ¨Ø±ØŒ ÙˆØ¹Ù†Ø¯ Ø§Ù„ÙÙˆØ² ØªØ³Ù…Ø¹ ØªØ¬Ø´Ø¤ ÙˆÙŠØ§ Ø¶Ø­ÙƒØ© ğŸ˜„</p>

    <div class="hud">
      <div class="stat">Ø§Ù„Ù†ØªÙŠØ¬Ø©: <span id="score" class="v">0</span></div>
      <div class="stat">Ø£ÙƒÙ„Øª: <span id="eaten" class="v">0</span> / <span id="target" class="v">50</span></div>
      <div class="stat">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="left" class="v">50</span></div>
      <div class="btns">
        <button id="startBtn">Ø§Ø¨Ø¯Ø£ / Ù…Ù† Ø¬Ø¯ÙŠØ¯</button>
        <button id="pauseBtn" class="sec">Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª (P)</button>
      </div>
    </div>

    <div class="canvas-wrap">
      <canvas id="game" width="600" height="600" aria-label="Ù„ÙˆØ­Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©"></canvas>

      <!-- Ø§Ù„ØªÙˆØ³Øª Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­Ø© -->
      <div id="toast" class="toast" aria-live="polite" aria-atomic="true"></div>

      <div id="overlay" class="overlay" role="dialog" aria-modal="true">
        <div class="card">
          <h2>Ø¬Ø§Ù‡Ø²ØŸ Ø®Ù„ Ù†Ù„Ø¹Ø¨! ğŸ®</h2>
          <div class="tips">
            <p>Ø±Ø£Ø³ Ø§Ù„Ø¯ÙˆØ¯Ø© ÙƒÙ„Ø¨ ğŸ¶ØŒ ÙˆØ§Ù„Ø£ÙƒÙ„ Ø£Ø­Ø°ÙŠØ© ğŸ‘ŸğŸ‘ğŸ¥¾ğŸ‘  ÙˆØºÙŠØ±Ù‡Ø§. Ù‡Ø¯ÙÙƒ ØªØ£ÙƒÙ„ <b>50</b> Ø­Ø°Ø§Ø¡ Ø­ØªÙ‰ ØªÙÙˆØ².</p>
            <ul>
              <li>Ø§Ù„ØªØ­ÙƒÙ…: Ø§Ù„Ø£Ø³Ù‡Ù… â¬…ï¸â¬†ï¸â¬‡ï¸â¡ï¸ Ø£Ùˆ WASD</li>
              <li>Ù…ÙˆØ¨Ø§ÙŠÙ„: Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù„Ù…Ø³ Ø¨Ø§Ù„Ø£Ø³ÙÙ„</li>
              <li>Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª: Ø²Ø± <span class="key">P</span></li>
            </ul>
            <div class="grid-legend">
              <span class="legend-item">Ø§Ù„Ø±Ø£Ø³: ğŸ¶</span>
              <span class="legend-item">Ø§Ù„Ø£ÙƒÙ„: ğŸ‘Ÿ/ğŸ‘/ğŸ¥¾/ğŸ‘ /â€¦ (Ø£ÙƒØ¨Ø±)</span>
              <span class="legend-item">Ø¬Ø³Ù… Ø§Ù„Ø¯ÙˆØ¯Ø©: Ø´ÙƒÙ„ Ø­ÙÙŠÙ‘Ø© Ø£ÙˆØ¶Ø­</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
    <div class="mobile-ctrl" aria-hidden="false">
      <span class="empty"></span>
      <button id="btnUp" class="sec">â¬†ï¸</button>
      <span class="empty"></span>
      <button id="btnLeft" class="sec">â¬…ï¸</button>
      <button id="btnDown" class="sec">â¬‡ï¸</button>
      <button id="btnRight" class="sec">â¡ï¸</button>
    </div>
  </div>

  <script>
    /*********** Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ ***********/
    const NAME_TEXT = "Ø¨ÙƒØ±";        // Ø§Ù„Ø§Ø³Ù… Ø¹Ù„Ù‰ Ø¬Ø³Ù… Ø§Ù„Ø¯ÙˆØ¯Ø©
    const GRID = 20;                // Ø­Ø¬Ù… Ø§Ù„Ø´Ø¨ÙƒØ© (Ø£Ù‚Ù„ = Ù…Ø±Ø¨Ø¹Ø§Øª Ø£ÙƒØ¨Ø± = ÙˆØ¶ÙˆØ­ Ø£Ø¹Ù„Ù‰)
    const BASE_SPEED_MS = 135;      // Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©
    const SPEED_STEP = 7;           // ÙƒÙ„ ÙƒÙ… Ù‚Ø·Ø¹Ø© ØªØªØ³Ø§Ø±Ø¹ Ø§Ù„Ø¯ÙˆØ¯Ø©
    const TARGET_EATS = 50;         // Ù‡Ø¯ÙÙƒ 50 Ø­Ø°Ø§Ø¡
    const MIN_SPEED_MS = 70;

    const BODY_BORDER = getComputedStyle(document.documentElement).getPropertyValue('--snakeBorder').trim();
    const BODY_FILL1 = getComputedStyle(document.documentElement).getPropertyValue('--snakeFill1').trim();
    const BODY_FILL2 = getComputedStyle(document.documentElement).getPropertyValue('--snakeFill2').trim();
    const HEAD_OUTLINE = getComputedStyle(document.documentElement).getPropertyValue('--accent2').trim();
    const WALL_HIT_COLOR = getComputedStyle(document.documentElement).getPropertyValue('--danger').trim();

    // Ø£Ø­Ø°ÙŠØ© (Ø£ÙƒØ¨Ø± ÙˆØ£ÙˆØ¶Ø­)
    const SHOES = ["ğŸ‘Ÿ","ğŸ‘","ğŸ¥¾","ğŸ‘ ","ğŸ¥¿","ğŸ©°","ğŸ©´","ğŸ›¼"];

    /*********** Ø¹Ù†Ø§ØµØ± DOM ***********/
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const scoreEl = document.getElementById("score");
    const eatenEl = document.getElementById("eaten");
    const targetEl = document.getElementById("target");
    const leftEl = document.getElementById("left");
    const overlay = document.getElementById("overlay");
    const startBtn = document.getElementById("startBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const toast = document.getElementById("toast");
    targetEl.textContent = TARGET_EATS;

    // Ø¯Ø¹Ù… Ø¯Ù‚Ø© Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø¹Ø§Ù„ÙŠØ© + Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù…Ø±Ø¨Ø¹
    function fitCanvasToDPR(){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const cssSize = canvas.getBoundingClientRect();
      const size = Math.min(cssSize.width, cssSize.height || cssSize.width);
      canvas.style.width = `${size}px`;
      canvas.style.height = `${size}px`;
      const px = Math.floor(size * dpr);
      canvas.width = px;
      canvas.height = px;
    }
    fitCanvasToDPR();
    window.addEventListener("resize", fitCanvasToDPR);

    let tile;   // Ø­Ø¬Ù… Ø§Ù„Ø®Ù„ÙŠØ© Ø¨Ø§Ù„Ø¨ÙƒØ³Ù„
    let state;

    function defaultState(){
      const cols = GRID, rows = GRID;
      tile = Math.floor(Math.min(canvas.width, canvas.height) / GRID);
      const startX = Math.floor(cols/2);
      const startY = Math.floor(rows/2);

      return {
        cols, rows,
        snake: [
          {x:startX, y:startY},
          {x:startX-1, y:startY},
          {x:startX-2, y:startY}
        ],
        dir: {x:1, y:0},
        nextDir: {x:1, y:0},
        food: spawnFoodRandom(cols, rows, new Set()),
        score: 0,
        eaten: 0,
        speedMs: BASE_SPEED_MS,
        running: false,
        paused: false,
        gameOver: false,
        won: false,
        tickHandle: null,
        lastStepAt: 0
      };
    }

    function coordKey(x,y){ return `${x},${y}`; }
    function snakeSet(snake){ const s = new Set(); for(const c of snake){ s.add(coordKey(c.x,c.y)); } return s; }

    function spawnFoodRandom(cols, rows, bannedSet){
      let x,y,tries=0;
      do{
        x = Math.floor(Math.random()*cols);
        y = Math.floor(Math.random()*rows);
        tries++; if(tries>500) break;
      }while(bannedSet.has(coordKey(x,y)));
      const emoji = SHOES[Math.floor(Math.random()*SHOES.length)];
      return {x,y,emoji};
    }

    function startGame(){
      state = defaultState();
      overlay.style.display = "none";
      hideToast(true);
      scoreEl.textContent = "0";
      eatenEl.textContent = "0";
      leftEl.textContent = TARGET_EATS;
      state.running = true;
      state.paused = false;
      state.gameOver = false;
      state.won = false;

      // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙˆØª Ø¨Ø¹Ø¯ ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      initAudio();

      scheduleNextTick(true);
      draw();
    }

    function pauseResume(){
      if(!state?.running || state?.gameOver) return;
      state.paused = !state.paused;
      if(!state.paused){ scheduleNextTick(true); resumeAudio(); }
      else { if(state.tickHandle) cancelAnimationFrame(state.tickHandle); state.tickHandle = null; }
      pauseBtn.textContent = state.paused ? "ØªØ§Ø¨Ø¹ Ø§Ù„Ù„Ø¹Ø¨ (P)" : "Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª (P)";
    }

    function scheduleNextTick(reset=false){
      if(reset && state.tickHandle){ cancelAnimationFrame(state.tickHandle); }
      state.lastStepAt = performance.now();
      const step = (t)=>{
        const elapsed = t - state.lastStepAt;
        if(elapsed >= state.speedMs){ stepGame(); state.lastStepAt = t; }
        draw();
        if(state.running && !state.paused && !state.gameOver){ state.tickHandle = requestAnimationFrame(step); }
      };
      state.tickHandle = requestAnimationFrame(step);
    }

    function stepGame(){
      if(!state || !state.running || state.paused || state.gameOver) return;

      const {x:nx, y:ny} = state.nextDir;
      if(!(nx === -state.dir.x && ny === -state.dir.y)){ state.dir = {x:nx, y:ny}; }

      const head = state.snake[0];
      const newHead = {x: head.x + state.dir.x, y: head.y + state.dir.y};

      // Ø­ÙŠØ·ØŸ
      if(newHead.x < 0 || newHead.y < 0 || newHead.x >= state.cols || newHead.y >= state.rows){
        return loseGame();
      }

      // Ø§ØµØ·Ø¯Ø§Ù… Ø¨Ø§Ù„Ù†ÙØ³ØŸ
      const bodySet = snakeSet(state.snake.slice(0, -1));
      if(bodySet.has(coordKey(newHead.x, newHead.y))){
        return loseGame();
      }

      // ØªØ­Ø±ÙŠÙƒ
      state.snake.unshift(newHead);

      // Ø£ÙƒÙ„ØŸ
      if(newHead.x === state.food.x && newHead.y === state.food.y){
        state.score += 10;
        state.eaten += 1;
        scoreEl.textContent = state.score;
        eatenEl.textContent = state.eaten;
        leftEl.textContent = Math.max(0, TARGET_EATS - state.eaten);

        playChomp();
        showToast("Ø¨Ø§Ù„Ø¹Ø§ÙÙŠØ© Ø¨ÙƒÙˆØ±ÙŠ");

        // ØªØ³Ø±ÙŠØ¹ ØªØ¯Ø±ÙŠØ¬ÙŠ
        if(state.eaten % SPEED_STEP === 0 && state.speedMs > MIN_SPEED_MS){
          state.speedMs -= 8;
        }

        // ÙÙˆØ² Ø¥Ø°Ø§ ÙˆØµÙ„ Ø§Ù„Ù‡Ø¯Ù
        if(state.eaten >= TARGET_EATS){
          return winGame();
        }

        // Ø³Ø¨ÙˆÙ† Ø£ÙƒÙ„ Ø¬Ø¯ÙŠØ¯
        const occupied = snakeSet(state.snake);
        state.food = spawnFoodRandom(state.cols, state.rows, occupied);
      } else {
        // Ù…Ø§ÙƒÙˆ Ø£ÙƒÙ„: Ù‚Øµ Ø§Ù„Ø°ÙŠÙ„
        state.snake.pop();
      }
    }

    function winGame(){
      state.won = true;
      state.gameOver = true;
      state.running = false;
      if(state.tickHandle){ cancelAnimationFrame(state.tickHandle); state.tickHandle = null; }

      playBurpLaugh();

      overlay.innerHTML = `
        <div class="card">
          <h2>ğŸ‰ ÙÙˆØ²! </h2>
          <p class="tips"><b>Ø¹ÙÙŠÙ‡ Ø¹Ù„ÙŠÙƒ Ø¨ÙƒÙˆØ±ÙŠ!</b> Ø£ÙƒÙ„Øª Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø­Ø°ÙŠØ©: <b>${state.eaten}</b></p>
          <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:8px">
            <button onclick="(${startGame.toString()})();">Ø£Ø¹Ø¯ Ø§Ù„Ù„Ø¹Ø¨</button>
            <button class="sec" onclick="document.getElementById('overlay').style.display='none'">Ø¥Ø®ÙØ§Ø¡</button>
          </div>
        </div>`;
      overlay.style.display = "flex";
      flashWallHit(0.08);
    }

    function loseGame(){
      state.gameOver = true;
      state.running = false;
      if(state.tickHandle){ cancelAnimationFrame(state.tickHandle); state.tickHandle = null; }

      overlay.innerHTML = `
        <div class="card">
          <h2>ğŸ’¥ Ø®Ø³Ø§Ø±Ø©</h2>
          <p class="tips"><b>Ø·ÙŠØ­ Ø§Ù„Ù„Ù‡ Ø­Ø¶Ùƒ Ø¨ÙƒØ±!</b> Ù…Ø§ Ø£ÙƒÙ„Øª Ø¨Ø³ <b>${state.eaten}</b> Ù…Ù† ${TARGET_EATS}</p>
          <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:8px">
            <button onclick="(${startGame.toString()})();">Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©</button>
            <button class="sec" onclick="document.getElementById('overlay').style.display='none'">Ø¥Ø®ÙØ§Ø¡</button>
          </div>
        </div>`;
      overlay.style.display = "flex";
      flashWallHit(0.12);
    }

    function flashWallHit(alpha=0.12){
      const orig = ctx.fillStyle;
      ctx.fillStyle = WALL_HIT_COLOR;
      ctx.globalAlpha = alpha;
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.globalAlpha = 1;
      ctx.fillStyle = orig;
    }

    /*********** Ø§Ù„Ø±Ø³Ù… ***********/
    function draw(){
      if(!state) return;
      const W = canvas.width, H = canvas.height;

      // Ø®Ù„ÙÙŠØ© Ø§Ù„Ø´Ø¨ÙƒØ©
      ctx.clearRect(0,0,W,H);
      drawGrid();

      // Ø§Ù„Ø£ÙƒÙ„ (Ø­Ø°Ø§Ø¡) â€” Ø£ÙƒØ¨Ø± ÙˆØ£ÙˆØ¶Ø­
      drawFood(state.food);

      // Ø§Ù„Ø¯ÙˆØ¯Ø© (Ø´ÙƒÙ„ Ø­ÙŠÙ‘Ø© Ø£ÙˆØ¶Ø­)
      drawSnake();
    }

    function drawGrid(){
      ctx.save();
      ctx.fillStyle = "#0f1216";
      ctx.fillRect(0,0,canvas.width,canvas.height);

      ctx.strokeStyle = "#111820";
      ctx.lineWidth = Math.max(1, tile * 0.03);
      ctx.globalAlpha = 0.5;
      for(let i=0;i<=state.cols;i++){
        ctx.beginPath(); ctx.moveTo(i*tile, 0); ctx.lineTo(i*tile, state.rows*tile); ctx.stroke();
      }
      for(let j=0;j<=state.rows;j++){
        ctx.beginPath(); ctx.moveTo(0, j*tile); ctx.lineTo(state.cols*tile, j*tile); ctx.stroke();
      }
      ctx.globalAlpha = 1;
      ctx.restore();
    }

    function drawFood(food){
      const {x,y,emoji} = food;
      const cx = x*tile + tile/2;
      const cy = y*tile + tile/2;
      ctx.save();
      const fontSize = Math.floor(tile*0.94); // Ø£ÙƒØ¨Ø±
      ctx.font = `${fontSize}px "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", sans-serif`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      // Ù‡Ø§Ù„Ø© Ø®ÙÙŠÙØ© Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙˆØ¶ÙˆØ­
      ctx.shadowColor = "rgba(0,0,0,.45)";
      ctx.shadowBlur = tile*0.14;
      ctx.fillText(emoji, cx, cy+1);
      ctx.restore();
    }

    // Ø±Ø³Ù… Ø¬Ø³Ù… Ø¨Ø´ÙƒÙ„ Ø­ÙŠØ© (ØªØ¯Ø±Ù‘Ø¬ + Ø¥Ø·Ø§Ø± + Ù‚Ø´ÙˆØ± Ø®ÙÙŠÙØ©)
    function drawSnake(){
      // Ø§Ù„Ø¬Ø³Ù…
      for(let i=state.snake.length-1;i>=1;i--){
        const seg = state.snake[i];
        const x = seg.x*tile, y = seg.y*tile;

        // Ø¥Ø·Ø§Ø± Ø®Ø§Ø±Ø¬ÙŠ
        ctx.save();
        const r = Math.max(4, Math.floor(tile*0.28));
        ctx.lineWidth = Math.max(2, tile*0.08);
        roundRect(ctx, x+1, y+1, tile-2, tile-2, r);
        ctx.strokeStyle = BODY_BORDER;
        ctx.stroke();

        // ØªØ¹Ø¨Ø¦Ø© Ù…ØªØ¯Ø±Ù‘Ø¬Ø© (Ù„ÙˆÙ† Ø­ÙŠÙ‘Ø©)
        const g = ctx.createLinearGradient(x, y, x, y+tile);
        g.addColorStop(0, BODY_FILL1);
        g.addColorStop(1, BODY_FILL2);
        ctx.fillStyle = g;
        roundRect(ctx, x+2, y+2, tile-4, tile-4, r*0.8);
        ctx.fill();

        // Ø­Ø²Ø§Ù…/Ø¨Ø·Ù† Ø®ÙÙŠÙ Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¥Ø­Ø³Ø§Ø³ Ø¨Ø§Ù„Ø´ÙƒÙ„
        ctx.globalAlpha = 0.12;
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(x+tile*0.18, y+tile*0.42, tile*0.64, tile*0.16);
        ctx.globalAlpha = 1;

        // Ù†Ù…Ø· Ù‚Ø´ÙˆØ± Ø®ÙÙŠÙ
        ctx.save();
        ctx.beginPath();
        roundRect(ctx, x+2, y+2, tile-4, tile-4, r*0.8);
        ctx.clip();
        ctx.globalAlpha = 0.08;
        ctx.fillStyle = "#053d33";
        const step = tile*0.33;
        for(let yy=y+step*0.6; yy<y+tile; yy+=step){
          for(let xx=x+step*0.6; xx<x+tile; xx+=step){
            ctx.beginPath();
            ctx.arc(xx, yy, step*0.38, 0, Math.PI*2);
            ctx.fill();
          }
        }
        ctx.restore();

        // ÙƒØªØ§Ø¨Ø© "Ø¨ÙƒØ±" Ø¹Ù„Ù‰ Ø¨Ø¹Ø¶ Ø§Ù„Ù‚Ø·Ø¹ (Ø£ÙˆØ¶Ø­)
        if(i % 2 === 0){
          ctx.save();
          ctx.fillStyle = "#073f37";
          ctx.font = `${Math.floor(tile*0.45)}px "Noto Naskh Arabic", "Segoe UI", Arial`;
          ctx.textAlign = "center"; ctx.textBaseline = "middle";
          ctx.fillText(NAME_TEXT, x + tile/2, y + tile/2 + 1);
          ctx.restore();
        }
        ctx.restore();
      }

      // Ø§Ù„Ø±Ø£Ø³ (ÙƒÙ„Ø¨) Ù…Ø¹ ØªØ¯ÙˆÙŠØ± Ø­Ø³Ø¨ Ø§Ù„Ø§ØªØ¬Ø§Ù‡
      const head = state.snake[0];
      const hx = head.x*tile, hy = head.y*tile;

      // Ø®Ù„ÙÙŠØ© Ø¥Ø·Ø§Ø± Ù„Ù„Ø±Ø£Ø³
      ctx.save();
      ctx.lineWidth = Math.max(2, tile*0.1);
      ctx.strokeStyle = HEAD_OUTLINE;
      ctx.fillStyle = "#15242a";
      roundRect(ctx, hx+1, hy+1, tile-2, tile-2, Math.max(6, tile*0.28));
      ctx.fill(); ctx.stroke();
      ctx.restore();

      const dir = state.dir;
      const centerX = hx + tile/2;
      const centerY = hy + tile/2;
      const angle = dir.x===1?0 : dir.x===-1?Math.PI : dir.y===1?Math.PI/2 : -Math.PI/2;

      ctx.save();
      ctx.translate(centerX, centerY);
      ctx.rotate(angle);
      const fontSize = Math.floor(tile*0.8);
      ctx.font = `${fontSize}px "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji"`;
      ctx.textAlign = "center"; ctx.textBaseline = "middle";
      ctx.fillText("ğŸ¶", 0, 1);
      ctx.restore();
    }

    function roundRect(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }

    /*********** ØªÙˆØ³Øª Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­Ø© ***********/
    let toastTimer = null;
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      if(toastTimer){ clearTimeout(toastTimer); }
      toastTimer = setTimeout(()=> toast.classList.remove("show"), 950);
    }
    function hideToast(immediate=false){
      if(immediate){
        toast.classList.remove("show");
        if(toastTimer){ clearTimeout(toastTimer); toastTimer=null; }
      } else {
        toast.classList.remove("show");
      }
    }

    /*********** ØµÙˆØªÙŠØ§Øª (Web Audio API) ***********/
    let audioCtx = null;
    function initAudio(){
      if(!audioCtx){
        const AC = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AC();
      }
      resumeAudio();
    }
    function resumeAudio(){
      if(audioCtx && audioCtx.state === "suspended"){ audioCtx.resume(); }
    }

    // ØµÙˆØª Ù‚Ø¶Ù… Ø³Ø±ÙŠØ¹
    function playChomp(){
      if(!audioCtx) return;
      const t0 = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      osc.type = "square";
      osc.frequency.setValueAtTime(620, t0);
      osc.frequency.exponentialRampToValueAtTime(180, t0 + 0.12);

      gain.gain.setValueAtTime(0.0001, t0);
      gain.gain.exponentialRampToValueAtTime(0.3, t0 + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.14);

      osc.connect(gain).connect(audioCtx.destination);
      osc.start(t0);
      osc.stop(t0 + 0.16);
    }

    // ØªØ¬Ø´Ø¤ + Ø¶Ø­ÙƒØ© Ø¨Ø³ÙŠØ·Ø© (ØªÙˆÙ„ÙŠØ¯ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ)
    function playBurpLaugh(){
      if(!audioCtx) return;
      const t0 = audioCtx.currentTime;

      // Burp: Ù†ØºÙ…Ø© Ø³ÙŠÙ†ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø© ØªÙ†Ø²Ù„Ù‚ Ù†Ø²ÙˆÙ„Ø§Ù‹
      const burpOsc = audioCtx.createOscillator();
      const burpGain = audioCtx.createGain();
      burpOsc.type = "sine";
      burpOsc.frequency.setValueAtTime(160, t0);
      burpOsc.frequency.exponentialRampToValueAtTime(70, t0 + 0.55);
      burpGain.gain.setValueAtTime(0.001, t0);
      burpGain.gain.exponentialRampToValueAtTime(0.45, t0 + 0.08);
      burpGain.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.6);
      burpOsc.connect(burpGain).connect(audioCtx.destination);
      burpOsc.start(t0);
      burpOsc.stop(t0 + 0.62);

      // Laugh: Ø«Ù„Ø§Ø« Ù†Ø¨Ø¶Ø§Øª â€œÙ‡Ø§ Ù‡Ø§ Ù‡Ø§â€
      for(let i=0;i<3;i++){
        const start = t0 + 0.65 + i*0.12;
        const laughOsc = audioCtx.createOscillator();
        const laughGain = audioCtx.createGain();
        laughOsc.type = "triangle";
        laughOsc.frequency.setValueAtTime(320 + i*20, start);
        laughGain.gain.setValueAtTime(0.001, start);
        laughGain.gain.exponentialRampToValueAtTime(0.25, start + 0.03);
        laughGain.gain.exponentialRampToValueAtTime(0.0001, start + 0.09);
        laughOsc.connect(laughGain).connect(audioCtx.destination);
        laughOsc.start(start);
        laughOsc.stop(start + 0.11);
      }
    }

    /*********** Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ***********/
    function setDir(dx,dy){
      if(state && (dx !== -state.dir.x || dy !== -state.dir.y)){
        state.nextDir = {x:dx, y:dy};
      }
    }

    window.addEventListener("keydown", (e)=>{
      const k = e.key.toLowerCase();
      if(["arrowup","w"].includes(k)) { e.preventDefault(); setDir(0,-1); }
      else if(["arrowdown","s"].includes(k)) { e.preventDefault(); setDir(0, 1); }
      else if(["arrowleft","a"].includes(k)) { e.preventDefault(); setDir(-1,0); }
      else if(["arrowright","d"].includes(k)) { e.preventDefault(); setDir(1,0); }
      else if(k==="p"){ pauseResume(); }
      else if(k==="enter" && overlay.style.display!=="none"){ startGame(); }
    }, {passive:false});

    startBtn.addEventListener("click", startGame);
    pauseBtn.addEventListener("click", pauseResume);

    document.getElementById("btnUp").addEventListener("click", ()=>setDir(0,-1));
    document.getElementById("btnDown").addEventListener("click", ()=>setDir(0,1));
    document.getElementById("btnLeft").addEventListener("click", ()=>setDir(-1,0));
    document.getElementById("btnRight").addEventListener("click", ()=>setDir(1,0));

    // Ø¨Ø¯Ø§ÙŠØ©: Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª
    overlay.style.display = "flex";
  </script>
</body>
</html>